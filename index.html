<html>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>æ‰‹æœºç¼–ç¨‹</title>
    <body>
    console.log('ç«¯å£:', window.location.port);
      <style>
      * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
}

body {
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    transition: background-color 0.3s, color 0.3s;
    overflow-x: hidden;
}

.app-container {
    display: flex;
    height: 100vh;
    overflow: hidden;
    position: relative;
}

/* èœå•æŒ‰é’® */
.menu-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    z-index: 1001;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: none;
}

/* ä¾§è¾¹æ æ ·å¼ - æ”¹ä¸ºä¾§æ‹‰æ¡† */
.sidebar {
    width: 320px;
    background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
    color: #ecf0f1;
    padding: 25px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    z-index: 1000;
    position: relative;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.15);
}

.sidebar-header h1 {
    font-size: 1.6rem;
    font-weight: 600;
}

.new-chapter-btn {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 14px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s;
    min-height: 50px;
}

.new-chapter-btn:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
}

/* æ ‡ç­¾é¡µæ ·å¼ */
.sidebar-tabs {
    display: flex;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 8px;
    gap: 6px;
}

.tab-btn {
    flex: 1;
    padding: 16px 20px;
    background: none;
    border: none;
    color: #bdc3c7;
    cursor: pointer;
    border-radius: 10px;
    transition: all 0.3s;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 500;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tab-btn.active {
    background: #3498db;
    color: white;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    transform: scale(1.02);
}

.tab-content {
    flex-grow: 1;
    overflow-y: auto;
}

.chapters-list, .history-list {
    display: none;
}

.chapters-list.active, .history-list.active {
    display: block;
}

/* ç« èŠ‚å’Œå†å²ç‰ˆæœ¬é¡¹æ ·å¼ */
.chapter-item, .history-item {
    padding: 20px 25px;
    margin-bottom: 12px;
    background-color: rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 5px solid transparent;
    min-height: 80px;
}

.chapter-item:hover, .history-item:hover {
    background-color: rgba(255, 255, 255, 0.18);
    transform: translateX(8px);
}

.chapter-item.active, .history-item.active {
    background-color: rgba(52, 152, 219, 0.35);
    border-left-color: #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.chapter-title, .history-title {
    font-weight: 600;
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 1.1rem;
    margin-right: 15px;
}

.history-info {
    font-size: 0.9rem;
    color: #bdc3c7;
    margin-top: 6px;
    opacity: 0.9;
}

.chapter-actions, .history-actions {
    display: flex;
    gap: 12px;
}

.chapter-action, .history-action {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: #ecf0f1;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.3s;
    padding: 10px 16px;
    border-radius: 8px;
    min-width: 60px;
    text-align: center;
}

.chapter-action:hover, .history-action:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

/* ä¸»ç¼–è¾‘åŒºæ ·å¼ */
.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: white;
    transition: background-color 0.3s;
    position: relative;
}

.editor-header {
    padding: 20px 30px;
    border-bottom: 2px solid #eaeaea;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color 0.3s;
}

.chapter-input {
    font-size: 1.6rem;
    font-weight: 700;
    border: none;
    outline: none;
    width: 70%;
    color: #2c3e50;
    background: transparent;
    transition: color 0.3s;
    padding: 10px 0;
}

.editor-toolbar {
    display: flex;
    gap: 12px;
}

.toolbar-btn {
    background: none;
    border: none;
    padding: 12px 18px;
    border-radius: 8px;
    cursor: pointer;
    color: #7f8c8d;
    transition: all 0.3s;
    font-size: 1rem;
    font-weight: 500;
    min-height: 50px;
}

.toolbar-btn:hover {
    background-color: #f0f0f0;
    color: #2c3e50;
    transform: translateY(-2px);
}

.editor-content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.editor-textarea {
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    resize: none;
    font-size: 1.2rem;
    line-height: 1.8;
    color: #2c3e50;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    background: transparent;
    transition: color 0.3s;
}

/* çŠ¶æ€æ æ ·å¼ */
.status-bar {
    padding: 15px 30px;
    background-color: #ecf0f1;
    border-top: 2px solid #dde4e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    color: #7f8c8d;
    transition: all 0.3s;
}

.word-count {
    font-weight: 600;
    font-size: 1.1rem;
}

/* é®ç½©å±‚ */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.overlay.active {
    display: block;
}

/* ç‰ˆæœ¬æ¯”è¾ƒæ¨¡æ€æ¡† */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 900px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 25px 30px;
    border-bottom: 2px solid #eaeaea;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.modal-header h2 {
    font-size: 1.8rem;
    color: #2c3e50;
}

.modal-body {
    padding: 25px 30px;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    gap: 25px;
}

.version-comparison {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.version-comparison h3 {
    font-size: 1.3rem;
    color: #2c3e50;
    margin-bottom: 10px;
}

.version-content {
    border: 2px solid #eaeaea;
    border-radius: 8px;
    padding: 20px;
    height: 350px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    background: #fafafa;
}

.modal-footer {
    padding: 20px 30px;
    border-top: 2px solid #eaeaea;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: #f8f9fa;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
    font-weight: 500;
    min-height: 50px;
    min-width: 120px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
}

/* ç‰ˆæœ¬æ¯”è¾ƒé¢œè‰²æ ‡è®° */
.added-char {
    background-color: #90EE90;
    color: #006400;
    padding: 1px 2px;
    border-radius: 2px;
    font-weight: bold;
}

.deleted-char {
    background-color: #FFB6C1;
    color: #8B0000;
    padding: 1px 2px;
    border-radius: 2px;
    text-decoration: line-through;
    font-weight: bold;
}

.modified-char {
    background-color: #FFD700;
    color: #8B4513;
    padding: 1px 2px;
    border-radius: 2px;
    font-weight: bold;
}

.diff-line {
    margin: 2px 0;
    line-height: 1.4;
}

/* å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯ä¾§æ‹‰æ¡† */
@media (max-width: 768px) {
    .menu-toggle {
        display: block;
    }
    
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        transform: translateX(-100%);
        box-shadow: 2px 0 20px rgba(0,0,0,0.3);
        width: 85%;
        max-width: 320px;
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .editor-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        padding: 15px 20px;
    }
    
    .chapter-input {
        width: 100%;
        font-size: 1.4rem;
    }
    
    .editor-toolbar {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .toolbar-btn {
        flex: 1;
        padding: 10px 8px;
        font-size: 0.9rem;
        min-height: 45px;
        margin: 2px;
    }
    
    .modal-body {
        flex-direction: column;
        padding: 20px;
    }
    
    .version-content {
        height: 250px;
    }
}

/* æš—è‰²ä¸»é¢˜ */
.dark-theme {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

.dark-theme .editor-container {
    background-color: #2d2d2d;
}

.dark-theme .editor-header {
    border-bottom-color: #444;
}

.dark-theme .chapter-input {
    color: #e0e0e0;
}

.dark-theme .editor-textarea {
    color: #e0e0e0;
}

.dark-theme .status-bar {
    background-color: #252525;
    border-top-color: #444;
    color: #aaa;
}

.dark-theme .toolbar-btn:hover {
    background-color: #444;
    color: #e0e0e0;
}

.dark-theme .modal-content {
    background: #2d2d2d;
    color: #e0e0e0;
}

.dark-theme .modal-header {
    background: #333;
    border-color: #444;
}

.dark-theme .modal-header h2 {
    color: #e0e0e0;
}

.dark-theme .modal-footer {
    background: #333;
    border-color: #444;
}

.dark-theme .version-content {
    border-color: #444;
    background: #1a1a1a;
    color: #e0e0e0;
}

.dark-theme .version-comparison h3 {
    color: #e0e0e0;
}

/* æš—è‰²ä¸»é¢˜ä¸‹çš„é¢œè‰²æ ‡è®° */
.dark-theme .added-char {
    background-color: #2E8B57;
    color: #98FB98;
}

.dark-theme .deleted-char {
    background-color: #8B0000;
    color: #FFB6C1;
}

.dark-theme .modified-char {
    background-color: #B8860B;
    color: #FFD700;
}

.version-content {
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.5);
}

/* ç©ºçŠ¶æ€æç¤º */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
    font-size: 1.1rem;
}

/* å…³é—­ä¾§è¾¹æ æŒ‰é’® */
.close-sidebar {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: #ecf0f1;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
}

@media (max-width: 768px) {
    .close-sidebar {
        display: block;
    }
}
      </style>
      <body>
    <!-- èœå•æŒ‰é’® -->
    <button class="menu-toggle" id="menuToggle">ğŸ“š ç« èŠ‚</button>
    
    <!-- é®ç½©å±‚ -->
    <div class="overlay" id="overlay"></div>
    
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <button class="close-sidebar" id="closeSidebar">Ã—</button>
            <div class="sidebar-header">
                <h1>å°è¯´å†™ä½œåŠ©æ‰‹</h1>
                <button class="new-chapter-btn" id="newChapterBtn">æ–°å»ºç« èŠ‚</button>
            </div>
            
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="chapters">ç« èŠ‚</button>
                <button class="tab-btn" data-tab="history">å†å²ç‰ˆæœ¬</button>
            </div>
            
            <div class="tab-content">
                <div class="chapters-list active" id="chaptersList">
                    <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="history-list" id="historyList">
                    <!-- å†å²ç‰ˆæœ¬åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ä¸»ç¼–è¾‘åŒº -->
        <div class="editor-container">
            <div class="editor-header">
                <input type="text" class="chapter-input" id="chapterTitle" placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜">
                <div class="editor-toolbar">
                    <button class="toolbar-btn" id="themeToggle">æš—è‰²æ¨¡å¼</button>
                    <button class="toolbar-btn" id="saveVersionBtn">ä¿å­˜ç‰ˆæœ¬</button>
                    <button class="toolbar-btn" id="exportBtn">å¯¼å‡ºå°è¯´</button>
                    <button class="toolbar-btn" id="saveBtn">ä¿å­˜</button>
                </div>
            </div>
            
            <div class="editor-content">
                <textarea class="editor-textarea" id="editor" placeholder="å¼€å§‹ä½ çš„åˆ›ä½œä¹‹æ—…..."></textarea>
            </div>
            
            <div class="status-bar">
                <div class="auto-save">è‡ªåŠ¨ä¿å­˜å·²å¼€å¯</div>
                <div class="word-count">å­—æ•°: <span id="wordCount">0</span></div>
            </div>
        </div>
    </div>

    <!-- ç‰ˆæœ¬æ¯”è¾ƒæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="compareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç‰ˆæœ¬æ¯”è¾ƒ</h2>
                <button class="toolbar-btn" id="closeModal">å…³é—­</button>
            </div>
            <div class="modal-body">
                <div class="version-comparison">
                    <h3>å½“å‰ç‰ˆæœ¬</h3>
                    <div class="version-content" id="currentVersionContent"></div>
                </div>
                <div class="version-comparison">
                    <h3>å†å²ç‰ˆæœ¬</h3>
                    <div class="version-content" id="historyVersionContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRestore">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmRestore">æ¢å¤æ­¤ç‰ˆæœ¬</button>
            </div>
        </div>
    </div>
    console.log(window. location.hostname);
    <script>
        // JavaScriptä»£ç å°†åœ¨è¿™é‡Œ
        // åº”ç”¨çŠ¶æ€
const state = {
    chapters: JSON.parse(localStorage.getItem('novelChapters')) || [
        { id: 1, title: 'ç¬¬ä¸€ç«  å¼€ç«¯', content: '' }
    ],
    currentChapterId: 1,
    isDarkTheme: localStorage.getItem('darkTheme') === 'true',
    versions: JSON.parse(localStorage.getItem('novelVersions')) || {},
    selectedVersion: null,
    isSidebarOpen: false
};

// DOMå…ƒç´ 
const elements = {
    menuToggle: document.getElementById('menuToggle'),
    overlay: document.getElementById('overlay'),
    sidebar: document.getElementById('sidebar'),
    closeSidebar: document.getElementById('closeSidebar'),
    chaptersList: document.getElementById('chaptersList'),
    historyList: document.getElementById('historyList'),
    chapterTitle: document.getElementById('chapterTitle'),
    editor: document.getElementById('editor'),
    wordCount: document.getElementById('wordCount'),
    newChapterBtn: document.getElementById('newChapterBtn'),
    themeToggle: document.getElementById('themeToggle'),
    exportBtn: document.getElementById('exportBtn'),
    saveBtn: document.getElementById('saveBtn'),
    saveVersionBtn: document.getElementById('saveVersionBtn'),
    compareModal: document.getElementById('compareModal'),
    currentVersionContent: document.getElementById('currentVersionContent'),
    historyVersionContent: document.getElementById('historyVersionContent'),
    closeModal: document.getElementById('closeModal'),
    cancelRestore: document.getElementById('cancelRestore'),
    confirmRestore: document.getElementById('confirmRestore')
};

// åˆå§‹åŒ–åº”ç”¨
function initApp() {
    
  
    
    
    renderChaptersList();
    loadChapter(state.currentChapterId);
    updateWordCount();
    setupTabSwitching();
    setupEventListeners();
    
    // åº”ç”¨ä¸»é¢˜
    if (state.isDarkTheme) {
        document.body.classList.add('dark-theme');
        elements.themeToggle.textContent = 'æµ…è‰²æ¨¡å¼';
    }
    
    // è®¾ç½®è‡ªåŠ¨ä¿å­˜ - ç« èŠ‚å†…å®¹æ¯3ç§’ä¿å­˜ï¼Œå†å²ç‰ˆæœ¬æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
    setInterval(saveCurrentChapter, 3000);

    // è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬åŠŸèƒ½
    let lastAutoSaveTime = 0;
    setInterval(() => {
        autoSaveVersion();
    }, 60000); // æ¯1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
}

// è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
function setupTabSwitching() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.tab-content > div').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'List').classList.add('active');
            
            // å¦‚æœæ˜¯å†å²ç‰ˆæœ¬æ ‡ç­¾ï¼Œåˆ·æ–°åˆ—è¡¨
            if (tabName === 'history') {
                renderHistoryList();
            }
        });
    });
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    elements.newChapterBtn.addEventListener('click', createNewChapter);
    elements.themeToggle.addEventListener('click', toggleTheme);
    elements.exportBtn.addEventListener('click', exportNovel);
    elements.saveBtn.addEventListener('click', saveCurrentChapter);
    elements.saveVersionBtn.addEventListener('click', saveVersion);
    elements.editor.addEventListener('input', updateWordCount);
    elements.closeModal.addEventListener('click', closeModal);
    elements.cancelRestore.addEventListener('click', closeModal);
    elements.confirmRestore.addEventListener('click', confirmRestore);
    
    // ä¾§è¾¹æ æ§åˆ¶
    elements.menuToggle.addEventListener('click', toggleSidebar);
    elements.overlay.addEventListener('click', closeSidebar);
    elements.closeSidebar.addEventListener('click', closeSidebar);
}

// åˆ‡æ¢ä¾§è¾¹æ 
function toggleSidebar() {
    state.isSidebarOpen = !state.isSidebarOpen;
    elements.sidebar.classList.toggle('active', state.isSidebarOpen);
    elements.overlay.classList.toggle('active', state.isSidebarOpen);
}

// å…³é—­ä¾§è¾¹æ 
function closeSidebar() {
    state.isSidebarOpen = false;
    elements.sidebar.classList.remove('active');
    elements.overlay.classList.remove('active');
}

// æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
function renderChaptersList() {
    elements.chaptersList.innerHTML = '';
    
    if (state.chapters.length === 0) {
        elements.chaptersList.innerHTML = '<div class="empty-state">æš‚æ— ç« èŠ‚ï¼Œç‚¹å‡»"æ–°å»ºç« èŠ‚"å¼€å§‹åˆ›ä½œ</div>';
        return;
    }
    
    state.chapters.forEach(chapter => {
        const chapterElement = document.createElement('div');
        chapterElement.className = `chapter-item ${chapter.id === state.currentChapterId ? 'active' : ''}`;
        chapterElement.innerHTML = `
            <div>
                <div class="chapter-title">${chapter.title || 'æœªå‘½åç« èŠ‚'}</div>
            </div>
            <div class="chapter-actions">
                <button class="chapter-action" data-id="${chapter.id}">åˆ é™¤</button>
            </div>
        `;
        
        chapterElement.addEventListener('click', (e) => {
            if (!e.target.classList.contains('chapter-action')) {
                if (chapter.id !== state.currentChapterId) {
                    saveCurrentChapter();
                    loadChapter(chapter.id);
                }
                // ç§»åŠ¨ç«¯ç‚¹å‡»åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
                if (window.innerWidth <= 768) {
                    closeSidebar();
                }
            }
        });
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        const deleteBtn = chapterElement.querySelector('.chapter-action');
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteChapter(chapter.id);
        });
        
        elements.chaptersList.appendChild(chapterElement);
    });
}

// æ¸²æŸ“å†å²ç‰ˆæœ¬åˆ—è¡¨
function renderHistoryList() {
    elements.historyList.innerHTML = '';
    
    const chapterVersions = state.versions[state.currentChapterId] || [];
    
    if (chapterVersions.length === 0) {
        elements.historyList.innerHTML = '<div class="empty-state">æš‚æ— å†å²ç‰ˆæœ¬</div>';
        return;
    }
    
    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
    chapterVersions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    chapterVersions.forEach((version, index) => {
        const versionElement = document.createElement('div');
        versionElement.className = 'history-item';
        versionElement.innerHTML = `
            <div>
                <div class="history-title">ç‰ˆæœ¬ ${chapterVersions.length - index} 
                    <span style="font-size:0.7rem; color:${version.type === 'manual' ? '#3498db' : '#95a5a6'}; margin-left:8px;">
                        ${version.type === 'manual' ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}
                    </span>
                </div>
                <div class="history-info">
                    ${formatDate(version.timestamp)} Â· ${version.wordCount} å­—
                </div>
            </div>
            <div class="history-actions">
                <button class="history-action compare-btn" data-id="${version.id}">æ¯”è¾ƒ</button>
                <button class="history-action restore-btn" data-id="${version.id}">æ¢å¤</button>
            </div>
        `;
        
        // ç»‘å®šæ¯”è¾ƒæŒ‰é’®äº‹ä»¶
        const compareBtn = versionElement.querySelector('.compare-btn');
        compareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            compareVersion(version.id);
        });
        
        // ç»‘å®šæ¢å¤æŒ‰é’®äº‹ä»¶
        const restoreBtn = versionElement.querySelector('.restore-btn');
        restoreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            restoreVersion(version.id);
        });
        
        elements.historyList.appendChild(versionElement);
    });
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(timestamp) {
    const date = new Date(timestamp);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

// åŠ è½½ç« èŠ‚
function loadChapter(chapterId) {
    const chapter = state.chapters.find(c => c.id === chapterId);
    if (chapter) {
        state.currentChapterId = chapterId;
        elements.chapterTitle.value = chapter.title || '';
        elements.editor.value = chapter.content || '';
        updateWordCount();
        renderChaptersList();
    }
}

// ä¿å­˜å½“å‰ç« èŠ‚
function saveCurrentChapter() {
    const chapterIndex = state.chapters.findIndex(c => c.id === state.currentChapterId);
    if (chapterIndex !== -1) {
        state.chapters[chapterIndex].title = elements.chapterTitle.value;
        state.chapters[chapterIndex].content = elements.editor.value;
        localStorage.setItem('novelChapters', JSON.stringify(state.chapters));
    }
}

// æ‰‹åŠ¨ä¿å­˜ç‰ˆæœ¬
function saveVersion() {
    const chapter = state.chapters.find(c => c.id === state.currentChapterId);
    if (!chapter) return;
    
    // åˆå§‹åŒ–ç‰ˆæœ¬å­˜å‚¨
    if (!state.versions[state.currentChapterId]) {
        state.versions[state.currentChapterId] = [];
    }
    
    const versions = state.versions[state.currentChapterId];
    const newVersionId = versions.length > 0 ? Math.max(...versions.map(v => v.id)) + 1 : 1;
    
    // ä½¿ç”¨æ·±æ‹·è´ä¿å­˜å½“å‰å†…å®¹ï¼Œé¿å…å¼•ç”¨é—®é¢˜
    const newVersion = {
        id: newVersionId,
        timestamp: new Date().toISOString(),
        title: chapter.title,
        content: JSON.parse(JSON.stringify(chapter.content)), // æ·±æ‹·è´å†…å®¹
        wordCount: calculateWordCount(chapter.content),
        type: 'manual' // æ ‡è®°ä¸ºæ‰‹åŠ¨ä¿å­˜
    };
    
    versions.push(newVersion);
    
    // é™åˆ¶æ¯ä¸ªç« èŠ‚æœ€å¤šä¿å­˜50ä¸ªç‰ˆæœ¬
    if (versions.length > 50) {
        versions.shift();
    }
    
    localStorage.setItem('novelVersions', JSON.stringify(state.versions));
    
    // åˆ·æ–°å†å²ç‰ˆæœ¬åˆ—è¡¨
    if (document.querySelector('.tab-btn[data-tab="history"]').classList.contains('active')) {
        renderHistoryList();
    }

    // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
    const originalText = elements.saveVersionBtn.textContent;
    elements.saveVersionBtn.textContent = 'å·²ä¿å­˜!';
    setTimeout(() => {
        elements.saveVersionBtn.textContent = originalText;
    }, 1000);
}

// è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬å‡½æ•°
function autoSaveVersion() {
    const chapter = state.chapters.find(c => c.id === state.currentChapterId);
    // å¦‚æœæ²¡æœ‰å†…å®¹æˆ–è€…å†…å®¹ä¸ºç©ºï¼Œä¸ä¿å­˜ç‰ˆæœ¬
    if (!chapter || !chapter.content || chapter.content.trim().length < 10) return;
    
    const now = Date.now();
    // æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ä¸€ä¸ªç‰ˆæœ¬ï¼ˆ300000æ¯«ç§’ï¼‰
    if (now - lastAutoSaveTime > 300000) {
        // åˆå§‹åŒ–ç‰ˆæœ¬å­˜å‚¨
        if (!state.versions[state.currentChapterId]) {
            state.versions[state.currentChapterId] = [];
        }
        
        const versions = state.versions[state.currentChapterId];
        const newVersionId = versions.length > 0 ? Math.max(...versions.map(v => v.id)) + 1 : 1;
        
        // ä½¿ç”¨æ·±æ‹·è´ä¿å­˜å½“å‰å†…å®¹
        const newVersion = {
            id: newVersionId,
            timestamp: new Date().toISOString(),
            title: chapter.title,
            content: JSON.parse(JSON.stringify(chapter.content)), // æ·±æ‹·è´å†…å®¹
            wordCount: calculateWordCount(chapter.content),
            type: 'auto' // æ ‡è®°ä¸ºè‡ªåŠ¨ä¿å­˜
        };
        
        versions.push(newVersion);
        
        // é™åˆ¶æ¯ä¸ªç« èŠ‚æœ€å¤šä¿å­˜50ä¸ªç‰ˆæœ¬ï¼ˆå› ä¸ºè‡ªåŠ¨ä¿å­˜ä¼šåˆ›å»ºå¾ˆå¤šï¼‰
        if (versions.length > 50) {
            versions.shift();
        }
        
        localStorage.setItem('novelVersions', JSON.stringify(state.versions));
        lastAutoSaveTime = now;
        
        console.log('è‡ªåŠ¨ä¿å­˜ç‰ˆæœ¬å®Œæˆ');
    }
}

// è®¡ç®—å­—æ•°
function calculateWordCount(text) {
    const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
    const otherWords = text.replace(/[\u4e00-\u9fa5]/g, '').trim().split(/\s+/).filter(word => word.length > 0);
    return chineseChars.length + otherWords.length;
}

// æ¯”è¾ƒç‰ˆæœ¬ - æ·»åŠ é¢œè‰²æ ‡è®°
function compareVersion(versionId) {
    const versions = state.versions[state.currentChapterId] || [];
    const version = versions.find(v => v.id === versionId);
    const currentChapter = state.chapters.find(c => c.id === state.currentChapterId);
    
    if (!version || !currentChapter) return;
    
    state.selectedVersion = versionId;
    
    const currentContent = currentChapter.content;
    const historyContent = version.content;
    
    // ç”Ÿæˆå¸¦é¢œè‰²æ ‡è®°çš„å†…å®¹
    const markedCurrentContent = markDifferences(currentContent, historyContent, 'current');
    const markedHistoryContent = markDifferences(historyContent, currentContent, 'history');
    
    elements.currentVersionContent.innerHTML = markedCurrentContent;
    elements.historyVersionContent.innerHTML = markedHistoryContent;
    
    elements.compareModal.classList.add('active');
}

// æ ‡è®°å·®å¼‚å†…å®¹
function markDifferences(text1, text2, type) {
    if (!text1 && !text2) return '';
    if (!text1) return text2;
    if (!text2) return text1;
    
    const lines1 = text1.split('\n');
    const lines2 = text2.split('\n');
    let result = '';
    
    const maxLines = Math.max(lines1.length, lines2.length);
    
    for (let i = 0; i < maxLines; i++) {
        const line1 = lines1[i] || '';
        const line2 = lines2[i] || '';
        
        if (line1 !== line2) {
            // è¡Œå†…å®¹ä¸åŒï¼Œè¿›è¡Œå­—ç¬¦çº§æ¯”è¾ƒ
            let markedLine = '';
            const maxLength = Math.max(line1.length, line2.length);
            
            for (let j = 0; j < maxLength; j++) {
                const char1 = line1[j] || '';
                const char2 = line2[j] || '';
                
                if (char1 !== char2) {
                    if (type === 'current') {
                        // å½“å‰ç‰ˆæœ¬ï¼šæ–°å¢å†…å®¹æ ‡ç»¿ï¼Œä¿®æ”¹å†…å®¹æ ‡é»„
                        if (char1 && !char2) {
                            markedLine += `<span class="added-char">${escapeHtml(char1)}</span>`;
                        } else {
                            markedLine += `<span class="modified-char">${escapeHtml(char1)}</span>`;
                        }
                    } else {
                        // å†å²ç‰ˆæœ¬ï¼šåˆ é™¤å†…å®¹æ ‡çº¢
                        if (char2 && !char1) {
                            markedLine += `<span class="deleted-char">${escapeHtml(char2)}</span>`;
                        } else {
                            markedLine += `<span class="modified-char">${escapeHtml(char2)}</span>`;
                        }
                    }
                } else {
                    markedLine += escapeHtml(char1);
                }
            }
            
            result += `<div class="diff-line">${markedLine}</div>`;
        } else {
            // è¡Œå†…å®¹ç›¸åŒ
            result += `<div>${escapeHtml(line1)}</div>`;
        }
    }
    
    return result;
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ¢å¤ç‰ˆæœ¬
function restoreVersion(versionId) {
    const versions = state.versions[state.currentChapterId] || [];
    const version = versions.find(v => v.id === versionId);
    
    if (!version) return;
    
    if (confirm(`ç¡®å®šè¦æ¢å¤åˆ°è¿™ä¸ªç‰ˆæœ¬å—ï¼Ÿå½“å‰å†…å®¹å°†è¢«æ›¿æ¢ã€‚`)) {
        const chapterIndex = state.chapters.findIndex(c => c.id === state.currentChapterId);
        if (chapterIndex !== -1) {
            // ä½¿ç”¨æ·±æ‹·è´æ¢å¤å†…å®¹
            state.chapters[chapterIndex].content = JSON.parse(JSON.stringify(version.content));
            localStorage.setItem('novelChapters', JSON.stringify(state.chapters));
            loadChapter(state.currentChapterId);
            closeModal();
        }
    }
}

// æ–°å»ºç« èŠ‚
function createNewChapter() {
    const newId = state.chapters.length > 0 ? 
        Math.max(...state.chapters.map(c => c.id)) + 1 : 1;
    
    const newChapter = {
        id: newId,
        title: `ç¬¬${state.chapters.length + 1}ç«  æ–°ç« èŠ‚`,
        content: ''
    };
    
    state.chapters.push(newChapter);
    saveCurrentChapter();
    loadChapter(newId);
    
    // ç§»åŠ¨ç«¯æ–°å»ºç« èŠ‚åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
    if (window.innerWidth <= 768) {
        closeSidebar();
    }
}

// åˆ é™¤ç« èŠ‚
function deleteChapter(chapterId) {
    if (state.chapters.length <= 1) {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç« èŠ‚');
        return;
    }
    
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        state.chapters = state.chapters.filter(c => c.id !== chapterId);
        
        if (state.currentChapterId === chapterId) {
            loadChapter(state.chapters[0].id);
        }
        
        localStorage.setItem('novelChapters', JSON.stringify(state.chapters));
        renderChaptersList();
    }
}

// æ›´æ–°å­—æ•°ç»Ÿè®¡
function updateWordCount() {
    const text = elements.editor.value;
    elements.wordCount.textContent = calculateWordCount(text);
}

// å¯¼å‡ºå°è¯´
function exportNovel() {
    if (state.chapters.length === 0) {
        alert('æ²¡æœ‰å†…å®¹å¯å¯¼å‡º');
        return;
    }
    
    let content = '';
    
    state.chapters.forEach(chapter => {
        content += `# ${chapter.title}\n\n`;
        content += `${chapter.content}\n\n`;
        content += '---\n\n';
    });
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'æˆ‘çš„å°è¯´.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// åˆ‡æ¢ä¸»é¢˜
function toggleTheme() {
    state.isDarkTheme = !state.isDarkTheme;
    document.body.classList.toggle('dark-theme');
    elements.themeToggle.textContent = state.isDarkTheme ? 'æµ…è‰²æ¨¡å¼' : 'æš—è‰²æ¨¡å¼';
    localStorage.setItem('darkTheme', state.isDarkTheme);
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    elements.compareModal.classList.remove('active');
    state.selectedVersion = null;
}

// ç¡®è®¤æ¢å¤ç‰ˆæœ¬
function confirmRestore() {
    if (state.selectedVersion) {
        restoreVersion(state.selectedVersion);
    }
}
// è·å–å½“å‰å®Œæ•´URL
function getCurrentURL() {
    return window.location.href;
}

// è·å–åŸºç¡€URLï¼ˆå»æ‰è·¯å¾„ï¼‰
function getBaseURL() {
    const url = new URL(window.location.href);
    return `${url.protocol}//${url.host}`;
}

// æ˜¾ç¤ºURLä¿¡æ¯
function showURLInfo() {
    const currentURL = getCurrentURL();
    const baseURL = getBaseURL();
    const port = window.location.port || '80 (é»˜è®¤)';
    
    const info = `
å®Œæ•´URL: ${currentURL}
åŸºç¡€ç½‘å€: ${baseURL}
ç«¯å£å·: ${port}
åè®®: ${window.location.protocol}
    `.trim();
    
    console.log(info);
    alert(info);
    
    return info;
}

// åœ¨åˆå§‹åŒ–æ—¶æ·»åŠ åˆ°å·¥å…·æ 
function addURLInfoButton() {
    const toolbar = document.querySelector('.editor-toolbar');
    const urlBtn = document.createElement('button');
    urlBtn.className = 'toolbar-btn';
    urlBtn.textContent = 'ç½‘å€ä¿¡æ¯';
    urlBtn.onclick = showURLInfo;
    toolbar.appendChild(urlBtn);
}

// åœ¨initAppä¸­è°ƒç”¨
 addURLInfoButton();
 
// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', initApp);
    </script>

    </body>
</html>